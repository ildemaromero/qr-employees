{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="flex">
    <!-- Side Panel -->
    {% include "side_panel.html" %}

    <!-- Main Content Area -->
    <main class="flex-1 md:ml-64 p-8">
        <div class="bg-white rounded-lg shadow-md p-6 max-w-4xl">
            <h1 class="text-2xl font-bold text-main-blue mb-4">Bienvenido, {{ user.username }}</h1>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-main-blue mb-3">Introduce la C√©dula</h2>
                <form id="qrForm" class="space-y-4">
                    <div>
                        <input type="text" name="document_number" id="document_number" placeholder="N√∫mero de C√©dula" required
                               class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-main-blue">
                    </div>
                    <button type="submit" class="bg-main-blue text-white px-4 py-2 rounded hover:bg-main-blue-dark transition">
                        Generar QR
                    </button>
                </form>

                <!-- QR Code Display Area -->
                <div id="qrResult" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-main-blue mb-2">QR Generado:</h3>
                    <div class="p-4 border rounded-md bg-gray-50 flex flex-col items-center">
                        <img id="qrImage" src="" alt="QR Code" class="w-64 h-64">
                        
                        <!-- Botones de acci√≥n -->
                        <div class="mt-4 flex space-x-4">
                            <button id="downloadBtn" class="flex items-center bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">
                                <span class="mr-2">‚¨áÔ∏è Descargar</span>
                            </button>
                            <button id="printBtn" class="flex items-center bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">
                                <span class="mr-2">üñ®Ô∏è Imprimir</span>
                            </button>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">Escanea este c√≥digo QR para acceder a la informaci√≥n</p>
                </div>

                <!-- Error Message Area -->
                <div id="errorMessage" class="mt-4 text-red-500 hidden"></div>
            </div>
        </div>
    </main>
</div>

<script>
let currentQrUrl = '';
let submittedDocumentNumber = '';

document.getElementById('qrForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    submittedDocumentNumber = document.getElementById('document_number').value;
    const qrResult = document.getElementById('qrResult');
    const qrImage = document.getElementById('qrImage');
    const errorMessage = document.getElementById('errorMessage');
    
    // Hide previous results/errors
    qrResult.classList.add('hidden');
    errorMessage.classList.add('hidden');
    
    try {
        const basePath = "{{ request.scope.get('root_path', '') }}";

        const response = await fetch(`${basePath}/generate-qr`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `document_number=${encodeURIComponent(submittedDocumentNumber)}`
        });        
        
        if (response.ok) {
            // Liberar la URL anterior si existe
            if (currentQrUrl) {
                URL.revokeObjectURL(currentQrUrl);
            }
            
            // Crear nueva URL del QR
            const blob = await response.blob();
            currentQrUrl = URL.createObjectURL(blob);
            
            // Mostrar el QR
            qrImage.src = currentQrUrl;
            qrResult.classList.remove('hidden');
        } else {
            throw new Error('No se encontr√≥ el empleado');
        }
    } catch (error) {
        errorMessage.textContent = 'Error al generar el c√≥digo QR. Por favor, int√©ntalo de nuevo.';
        errorMessage.classList.remove('hidden');
        console.error('Error:', error);
    }
});

document.getElementById('downloadBtn').addEventListener('click', function() {
    if (!currentQrUrl || !submittedDocumentNumber) return;
    
    const fileName = `qr-${submittedDocumentNumber}.png`;
    
    const link = document.createElement('a');
    link.href = currentQrUrl;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

document.getElementById('printBtn').addEventListener('click', function() {
    if (!currentQrUrl) return;
    
    const printWindow = window.open('', '', 'width=600,height=600');
    printWindow.document.write(`
        <img src="${currentQrUrl}" style="display:block;margin:auto;max-width:100%;">
        <script>
            setTimeout(() => {
                window.print();
                window.close();
            }, 300);
        <\/script>
    `);
    printWindow.document.close();
});

</script>
{% endblock %}